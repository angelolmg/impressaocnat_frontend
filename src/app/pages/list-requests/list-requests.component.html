<div class="content">
	<div class="top-shelf">
		<h2 class="page-title">Todas as Solicitações</h2>

		<form [formGroup]="queryForm" class="my-options">
			<button
				mat-icon-button
				matTooltip="Baixar .csv"
				aria-label="Download button"
			>
				<mat-icon>download</mat-icon>
			</button>

			<mat-form-field>
				<mat-label>Filtrar por Data</mat-label>
				<mat-date-range-input [rangePicker]="picker">
					<input matStartDate placeholder="Início" formControlName="startDate"/>
					<input matEndDate placeholder="Fim" formControlName="endDate"/>
				</mat-date-range-input>

				<mat-datepicker-toggle
					matIconSuffix
					[for]="picker"
				></mat-datepicker-toggle>
				<mat-date-range-picker #picker></mat-date-range-picker>
			</mat-form-field>

			<mat-form-field>
				<mat-label>Filtrar por Atributo</mat-label>
				<input matInput placeholder="Nº, Matrícula, etc" formControlName="query" />
				<mat-icon matSuffix>search</mat-icon>
			</mat-form-field>
		</form>
	</div>

	<div class="table-wrapper">
		<table
			mat-table
			[dataSource]="requests"
			matSort
			class="mat-elevation-z8"
			[style.height.%]="
				10 *
				(paginator.pageSize / paginator.length != 1 &&
				paginator.pageIndex == paginator.getNumberOfPages() - 1
					? paginator.length % paginator.pageSize
					: paginator.pageSize)
			"
		>
			<ng-container matColumnDef="id">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					sortActionDescription="Ordenar por ID"
				>
					ID
				</th>
				<td mat-cell *matCellDef="let element">
					{{ element.id.toString().padStart(6, "0") }}
				</td>
			</ng-container>

			<ng-container matColumnDef="creationDate">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					sortActionDescription="Ordenar por data de criação"
				>
					Data de Criação
				</th>
				<td mat-cell *matCellDef="let element">
					{{ element.creationDate | date : "short" }}
				</td>
			</ng-container>

			<ng-container matColumnDef="term">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					sortActionDescription="Ordenar por prazo"
				>
					Prazo (horas)
				</th>
				<td mat-cell *matCellDef="let element">
					{{ element.term / 3600 }}
				</td>
			</ng-container>

			<ng-container matColumnDef="username">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					sortActionDescription="Ordenar por nome do usuário"
				>
					Solicitante
				</th>
				<td mat-cell *matCellDef="let element">
					{{ element.username }}
				</td>
			</ng-container>

			<ng-container matColumnDef="registration">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					sortActionDescription="Ordenar por matrícula"
				>
					Matrícula
				</th>
				<td mat-cell *matCellDef="let element">
					{{ element.registration }}
				</td>
			</ng-container>

			<ng-container matColumnDef="status">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					sortActionDescription="Ordenar por situação"
				>
					Situação
				</th>
				<td mat-cell *matCellDef="let element">
					{{ element.status ? "Pendente" : "Fechado" }}
				</td>
			</ng-container>

			<ng-container matColumnDef="conclusionDate">
				<th
					mat-header-cell
					*matHeaderCellDef
					mat-sort-header
					sortActionDescription="Ordenar por data de conclusão"
				>
					Data de Conclusão
				</th>
				<td mat-cell *matCellDef="let element">
					{{
						element.conclusionDate
							? (element.conclusionDate | date : "short")
							: "Pendente"
					}}
				</td>
			</ng-container>

			<ng-container matColumnDef="actions">
				<th mat-header-cell *matHeaderCellDef>Ações</th>
				<td mat-cell *matCellDef="let element">
					@for (action of allowedActions; track $index) {
					<button
						[hidden]="
							(action == 'Abrir' && !element.conclusionDate) ||
							(action == 'Fechar' && element.conclusionDate)
						"
						[disabled]="
							actionService.disabledHandler(
								'list-requests',
								undefined,
								action,
								element
							)
						"
						mat-icon-button
						matTooltip="{{ action }}"
						aria-label="Action button"
						(click)="actionService.callbackHandler(action, element)"
					>
						<mat-icon>{{ action | icon }}</mat-icon>
					</button>
					}
				</td>
			</ng-container>

			<tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
			<tr
				mat-row
				*matRowDef="let row; columns: displayedColumns"
				[class.concluded]="row.conclusionDate"
			></tr>
		</table>

		@if(loadingData()) {
		<div class="overlay">
			<mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
		</div>
		}
	</div>

	<mat-paginator
		#paginator
		showFirstLastButtons
		(page)="handlePageEvent($event)"
		[length]="100"
		[pageSize]="10"
		[pageSizeOptions]="[10]"
		aria-label="Select page"
	>
	</mat-paginator>
</div>
